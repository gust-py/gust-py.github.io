<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Falcon 9 & Earth 3D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #ui { position: absolute; top: 20px; left: 20px; color: #0f0; pointer-events: none; font-size: 16px; z-index: 10; }
        .data { margin-bottom: 5px; text-shadow: 2px 2px 4px #000; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 5px; }
        span { color: #fff; font-weight: bold; }
        #motor-btn { 
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 18px 60px; background: rgba(138, 43, 226, 0.2); border: 2px solid #8a2be2; 
            color: white; font-size: 14px; letter-spacing: 5px; cursor: pointer;
            z-index: 10; transition: all 0.3s; user-select: none; border-radius: 8px;
            box-shadow: 0 0 15px #8a2be2;
        }
        #motor-btn:active { background: #8a2be2; color: #fff; }
    </style>
</head>
<body>
<div id="ui">
    <div class="data">ALTITUDE: <span id="alt">0</span> m</div>
    <div class="data">VELOCIDADE: <span id="vel">0</span> m/s</div>
</div>
<div id="motor-btn">IGNIÇÃO</div>

<script type="importmap">
    { 
        "imports": { 
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        } 
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    const T = THREE;
    const RAIO_TERRA = 637100; // 637.1km na escala do simulador
    
    const scene = new T.Scene();
    const camera = new T.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 5000000);
    camera.position.set(0, RAIO_TERRA + 150, 300);

    const renderer = new T.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = T.ACESFilmicToneMapping;
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Efeito de brilho (Bloom) para destacar o fogo azul e a atmosfera
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloom = new UnrealBloomPass(new T.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    composer.addPass(bloom);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Luzes
    scene.add(new T.AmbientLight(0xffffff, 0.8));
    const sun = new T.DirectionalLight(0xffffff, 2.5);
    sun.castShadow = true;
    scene.add(sun);

    const loader = new GLTFLoader();

    // --- CARREGAR TERRA 3D ---
    loader.load('earth.gltf', (gltf) => {
        const earthModel = gltf.scene;
        // Ajustamos para o tamanho real solicitado
        earthModel.scale.set(RAIO_TERRA, RAIO_TERRA, RAIO_TERRA); 
        earthModel.receiveShadow = true;
        scene.add(earthModel);
    });

    // --- ATMOSFERA VISUAL (Glow) ---
    const atmoGeom = new T.SphereGeometry(RAIO_TERRA + 15000, 64, 64);
    const atmoMat = new T.MeshPhongMaterial({
        color: 0x4488ff,
        transparent: true,
        opacity: 0.2,
        side: T.BackSide
    });
    const atmosphere = new T.Mesh(atmoGeom, atmoMat);
    scene.add(atmosphere);

    // --- CARREGA FALCON 9 ---
    const rocket = new T.Group();
    scene.add(rocket);

    loader.load('f9.gltf', (gltf) => {
        const f9 = gltf.scene;
        f9.scale.set(8, 8, 8); // Ajuste conforme necessário
        f9.traverse(n => { if(n.isMesh) n.castShadow = n.receiveShadow = true; });
        rocket.add(f9);
    });

    // --- FOGO AZUL / VIOLETA ---
    const fireTex = new T.CanvasTexture((() => {
        const c = document.createElement('canvas'); c.width = 64; c.height = 64;
        const ctx = c.getContext('2d');
        const g = ctx.createRadialGradient(32,32,0,32,32,32);
        g.addColorStop(0, '#ffffff');    // Centro branco
        g.addColorStop(0.3, '#8a2be2');  // Violeta
        g.addColorStop(0.7, '#0000ff');  // Azul profundo
        g.addColorStop(1, 'transparent');
        ctx.fillStyle = g; ctx.fillRect(0,0,64,64); return c;
    })());

    const firePs = [];
    for(let i=0; i<25; i++) {
        const s = new T.Sprite(new T.SpriteMaterial({map:fireTex, blending: T.AdditiveBlending, transparent:true}));
        s.visible=false; rocket.add(s); firePs.push(s);
    }

    // Variáveis de voo
    let alt = 0, vel = 0, engine = false;
    const btn = document.getElementById('motor-btn');
    btn.onmousedown = btn.ontouchstart = (e) => { e.preventDefault(); engine = true; };
    btn.onmouseup = btn.ontouchend = () => engine = false;

    function animate() {
        requestAnimationFrame(animate);
        
        if(engine) {
            vel += 4.5;
            firePs.forEach(p => {
                p.visible = true;
                p.position.set((Math.random()-0.5)*3, -Math.random()*35 - 5, (Math.random()-0.5)*3);
                p.scale.set(10, 30, 1);
            });
        } else {
            if (alt > 0) vel -= 1.62;
            firePs.forEach(p => p.visible=false);
        }

        alt += (vel/60);
        if(alt < 0) { alt=0; vel=0; }
        
        const curY = RAIO_TERRA + alt;
        rocket.position.y = curY;

        // Luz e Camera seguem o foguete
        sun.position.set(200, curY + 500, 200);
        sun.target.position.set(0, curY, 0);
        controls.target.set(0, curY + 20, 0);

        // Cor do céu muda com a altitude
        const atmoLimit = 100000;
        const factor = Math.min(1, alt / atmoLimit);
        scene.background = new T.Color(0x0a0a2a).lerp(new T.Color(0x000000), factor);

        controls.update();
        composer.render();
        
        document.getElementById('alt').innerText = Math.floor(alt).toLocaleString('pt-BR');
        document.getElementById('vel').innerText = Math.floor(vel).toLocaleString('pt-BR');
    }
    animate();

    window.onresize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    };
</script>
</body>
</html>
